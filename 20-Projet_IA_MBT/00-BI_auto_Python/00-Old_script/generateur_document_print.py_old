# -*- coding: utf-8 -*-
import gradio as gr
from docx import Document
import subprocess
import sys
import os
import platform
from docx2pdf import convert

# Verifie et installe les bibliotheques necessaires
def check_install_libraries():
    required_libraries = ["gradio", "python-docx", "docx2pdf"]
    for lib in required_libraries:
        try:
            __import__(lib)
        except ImportError:
            subprocess.check_call([sys.executable, "-m", "pip", "install", lib])

check_install_libraries()

def replace_text_in_runs(runs, placeholder, replacement):
    for run in runs:
        if placeholder in run.text:
            run.text = run.text.replace(placeholder, replacement)

def print_document(file_path):
    try:
        if not isinstance(file_path, (str, bytes, os.PathLike)):
            raise ValueError(f"Chemin de fichier invalide : {file_path}")
        
        subprocess.run([
            'D:\\10-Tools\\08-SumatraPDF\\SumatraPDF\\SumatraPDF.exe',
            '-silent',
            file_path
        ], check=True)
    except subprocess.CalledProcessError as e:
        print(f"Erreur d'impression (code {e.returncode}) : {e}")
    except Exception as e:
        print(f"Erreur inattendue : {e}")

def generate_document(template, date, intervenant, mail_intervenant, societe, nom_contact, mail_contact, duree_inter, date_deb, date_fin, obj_presta, contenu_intervention):
    doc = Document(template)

    # Remplacement dans les paragraphes
    for paragraph in doc.paragraphs:
        for placeholder, value in {
            '[DATE]': date, '[INTERVENANT]': intervenant, '[MAIL_INTERVENANT]': mail_intervenant,
            '[SOCIETE]': societe, '[NOM_CONTACT]': nom_contact, '[MAIL_CONTACT]': mail_contact,
            '[DUREE_INTER]': duree_inter, '[DATE_DEB]': date_deb, '[DATE_FIN]': date_fin,
            '[OBJ_PRESTA]': obj_presta, '[CONTENU_INTERVENTION]': contenu_intervention
        }.items():
            replace_text_in_runs(paragraph.runs, placeholder, value)

    # Remplacement dans les tableaux
    for table in doc.tables:
        for row in table.rows:
            for cell in row.cells:
                for paragraph in cell.paragraphs:
                    for placeholder, value in {
                        '[DATE]': date, '[INTERVENANT]': intervenant, '[MAIL_INTERVENANT]': mail_intervenant,
                        '[SOCIETE]': societe, '[NOM_CONTACT]': nom_contact, '[MAIL_CONTACT]': mail_contact,
                        '[DUREE_INTER]': duree_inter, '[DATE_DEB]': date_deb, '[DATE_FIN]': date_fin,
                        '[OBJ_PRESTA]': obj_presta, '[CONTENU_INTERVENTION]': contenu_intervention
                    }.items():
                        replace_text_in_runs(paragraph.runs, placeholder, value)

    # En-tï¿½tes et pieds de page
    for section in doc.sections:
        for part in [section.header, section.footer]:
            for paragraph in part.paragraphs:
                for placeholder, value in {
                    '[DATE]': date, '[INTERVENANT]': intervenant, '[MAIL_INTERVENANT]': mail_intervenant,
                    '[SOCIETE]': societe, '[NOM_CONTACT]': nom_contact, '[MAIL_CONTACT]': mail_contact,
                    '[DUREE_INTER]': duree_inter, '[DATE_DEB]': date_deb, '[DATE_FIN]': date_fin,
                    '[OBJ_PRESTA]': obj_presta, '[CONTENU_INTERVENTION]': contenu_intervention
                }.items():
                    replace_text_in_runs(paragraph.runs, placeholder, value)

    # Sauvegarde et conversion
    output_docx = f"BI_{societe}.docx"
    output_pdf = output_docx.replace(".docx", ".pdf")
    doc.save(output_docx)
    convert(output_docx, output_pdf)
    os.remove(output_docx)

    # Impression
    print_document(output_pdf)

    return output_pdf

# Interface Gradio
iface = gr.Interface(
    fn=generate_document,
    inputs=[
        gr.Dropdown(["template_bon-intervention.docx"], label="Template"),
        gr.Textbox(label="Date"),
        gr.Textbox(label="Intervenant"),
        gr.Textbox(label="Mail Intervenant"),
        gr.Textbox(label="Societe"),
        gr.Textbox(label="Nom Contact"),
        gr.Textbox(label="Mail Contact"),
        gr.Textbox(label="Duree Intervention"),
        gr.Textbox(label="Date Debut"),
        gr.Textbox(label="Date Fin"),
        gr.Textbox(label="Objectif Prestation"),
        gr.Textbox(label="Contenu Intervention")
    ],
    outputs=gr.File(label="Bon d'intervention (PDF)"),
    title="BON D'INTERVENTION",
    description="Genere et imprime automatiquement un bon d'intervention au format PDF."
)

iface.launch()
